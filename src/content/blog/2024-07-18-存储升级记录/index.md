---
title: 存储升级记录
slug: storage-upgrade-log
tags: [homelab]
description: 这问是关于存储升级的记录。作者详细描述了硬盘的选择、转接卡带宽问题、供电问题、硬盘的具体情况以及文件系统的选择。作者最终选择了LVM管理硬盘，并对硬盘进行了详细的规划和分配。
created_at: 2024-07-16T18:28:00.000Z
updated_at: 2024-07-16T18:28:00.000Z
---

最近在 TG 群抽奖获得了一个 mt💊和一个月 VIP, 不怎么折腾 PT 的我终于有机会入门了。有了 VIP，下载任何资源是不计算下载量的，于是可以买个盒子下载大包刷流来提高上传数据。不过等这个月 VIP 没有之后就不能这么玩了。想要长期玩还是得保种赚魔力，这就需要长期在线和大容量存储的支持。于是有了  拓展存储的~~借口~~需求。

考虑到 PT 存储的都是丢了无所谓的数据，加上今年硬盘涨价了，所以消费降级入了一个二手的企业盘。

## 转接卡的带宽问题

因为主板只有 4 个 SATA 接口，而我有 7 个硬盘，所以之前买过一张 PCI-E 1.0 x4 转 4 SATA 转接卡，这样就可以接入更多的硬盘了。这次升级的时候就比较好奇这张转接口会不会成为硬盘传输的瓶颈，于是查了一下 SATA 和 PCIE 的带宽。

首先 SATA 的带宽带宽是多少？[来源](https://zh.wikipedia.org/wiki/SATA)

| 版本         | 带宽    | 理论速度 | 编码      |
| ------------ | ------- | -------- | --------- |
| SATA Express | 16Gb/s  | 1969MB/s | 128b/130b |
| SATA 3.0     | 6Gb/s   | 600MB/s  | 8b/10b    |
| SATA 2.0     | 3Gb/s   | 300MB/s  | 8b/10b    |
| SATA 1.0     | 1.5Gb/s | 150MB/s  | 8b/10b    |

PCIE 的速度？[来源](https://zh.wikipedia.org/wiki/PCI_Express)

| 规格             | 总线宽度 | 工作主频       | 资料速率          |
| ---------------- | -------- | -------------- | ----------------- |
| PCI 2.3          | 32 位    | 33/66 MHz      | 133/266 MB/s      |
| PCI-X 1.0        | 64 位    | 66/100/133 MHz | 533/800/1066 MB/s |
| PCI-X 2.0（DDR） | 64 位    | 133 MHz        | 2.1 GB/s          |
| PCI-X 2.0（QDR） | 64 位    | 133 MHz        | 4.2 GB/s          |
| AGP 2X           | 32 位    | 66 MHz         | \*2=532 MB/s      |
| AGP 4X           | 32 位    | 66 MHz         | \*4=1.0 GB/s      |
| AGP 8X           | 32 位    | 66 MHz         | \*8=2.1 GB/s      |
| PCI-E 1.0 X1     | 1 比特   | 2.5 GHz        | 250 MB/s          |
| PCI-E 1.0 X2     | 2 比特   | 2.5 GHz        | 500 MB/s          |
| PCI-E 1.0 X4     | 4 位     | 2.5 GHz        | 1 GB/s            |
| PCI-E 1.0 X8     | 8 位     | 2.5 GHz        | 2 GB/s            |
| PCI-E 1.0 X16    | 16 位    | 2.5 GHz        | 4 GB/s            |

sata3 接口的最大带宽是 600MB/s ,但是现在实际每个机械硬盘的实际最大读速度能达到多少？

机械硬盘的实际读写速度受到许多因素的影响，包括硬盘的转速、磁头的移动速度、数据的物理位置等。一般来说，现代的 7200 转/分钟的机械硬盘，其连续读写速度可以达到 150-200MB/s。但是，这是在理想情况下，实际的速度可能会因为各种因素而有所不同。

按照一个硬盘的最大读写速度是 200MB/s 来计算，所以一根 sata3 线的带宽理论上可以同时承载 600/200 = 3 个硬盘进行并发读写。再看 pci-e 1.0 x4 的带宽是 1GB/s, 所以一个 pci-e 1.0 x4 的接口可以同时承载 (1024/200 = 5.12) 个硬盘进行并发读写似乎没什么问题。

## 供电问题

机箱电源只提供了 4 个 sata 电源接口，但是我有 7 个硬盘，不过电源的 4pin 接口还有几个，所以买了几根 4pin 转 15pin 的转接线，这样就可以接入更多的硬盘了。不过考虑到这几个 4pin 口是串联在一条电源线上的，保险起见把他们给小硬盘使用了。

最后列下自己目前拥有的硬盘 7 个数量具体情况：

| 序号 | 硬盘型号               | 容量 | 数量 | 尺寸 | 来源            | 备注                | 数据接口 | 电源接口  |
| ---- | ---------------------- | ---- | ---- | ---- | --------------- | ------------------- | -------- | --------- |
| 1    | ST1000LM048-2E7172     | 1TB  | 1    | 2.5  | 2017 年购于京东 | 希捷三星 SMR 硬盘   | 转接口   | 4pin 转接 |
| 2    | ST1000LM024 HN-M101MBB | 1TB  | 1    | 2.5  | 14 年笔记本淘汰 | 希捷酷鱼 smart 红色 | 转接口   | 4pin 转接 |
| 3    | TOSHIBA DT01ACA100     | 1TB  | 2    | 3.5  | 2019 年购于京东 | 东芝                | 主板     | 电源      |
| 4    | WDC WD40EFRX-68WT0N0   | 4TB  | 1    | 3.5  | 2017 年购于淘宝 | 西数红盘 smart 黄色 | 主板     | 电源      |
| 5    | DS42HKVS-78C4GY0       | 4TB  | 1    | 3.5  | 2023 年购于 pdd | 西数紫盘            | 转接口   | 4pin 转接 |
| 6    | WUH721816ALE6L4        | 16TB | 1    | 3.5  | 2024 年购于淘宝 | 西数企业盘 二手     | 主板     | 电源      |

## 文件系统的选择

硬件折腾完了就要开始折腾软件了，当我将新买的 16T 插入电脑后我发现它使用了一个我之前没听过的文件系统：XFS。

因为目前我的存储系统是通过 omv 搭建的，在搭建 omv 之前使用过一阵子 zfs, 经历过数据丢失之后我就放弃了 zfs。然后在 omv 系统里面为每个硬盘选用的基本都是 ext4 文件系统，原因还是它的稳定性和兼容性，毕竟有两块 smart 不是特别正常的硬盘，用 ext4 文件系统就算出了问题网上找资料也比较多。

查询一圈资料，xfs 好像和 ext4 差不多，最大的卖点就是对大文件有更好的支持。不过我不太需要这个特性，通过这个[性能对比](https://www.phoronix.com/news/Linux-5.14-File-Systems) 得知，ext4 在性能上还是比其他新的文件系统要好一些，所以我还是倾向选择 ext4 文件系统。

另外在查询它们区别的时候我发现了一种新的管理文件系统的方案：[lvm](https://www.markus-gattol.name/ws/lvm.html)。lvm 是一种逻辑卷管理器，它可以将多个硬盘组合成一个逻辑卷，然后在逻辑卷上创建文件系统。为了体验不同的文件系统，你可以创建多个不同的逻辑卷。
而且 lvm 具有快照功能，它的实现原理用到了写时复制。用快照的具体场景就是一致性备份，也就是在备份的时候进行一次快照，这样在备份期间的变更不会进入备份文件中，备份完成后删除快照即可。这样就可以保证备份的一致性。

lvm 创建出来的逻辑卷支持扩容和缩容，扩容之后分区需要执行 resize2fs 命令才能生效。但是缩容的先后次序比较重要，必须先缩小文件系统，再缩小逻辑卷，否则会导致数据丢失，可以参考这里[缩小逻辑卷](https://linux.cn/article-12740-1.html)。

最后我将自己的 1,3,5 号硬盘都加入了 lvm 管理，然后创建了一个 7T 的卷组，逻辑卷打算按照用户来创建，一个用户一个逻辑卷。
剩下的 2,4,6 都有一定的风险，所以没有加入 lvm 管理。2 号盘作为下载专用盘，下载完毕之后转移到 4 号盘，4 号盘作为保种盘。
6 号的定位还没想好，暂时作为重要数据的热备盘吧


